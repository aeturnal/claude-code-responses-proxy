---
phase: 06-token-count-billing-alignment-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/verify_count_tokens.py
  - scripts/fixtures/token_count_cases.json
  - .planning/phases/06-token-count-billing-alignment-verification/06-VERIFICATION.md
  - .planning/phases/06-token-count-billing-alignment-verification/06-token-count-billing-alignment-report.md
  - .planning/phases/02-token-counting-alignment/02-token-counting-alignment-VERIFICATION.md
autonomous: true
user_setup:
  - service: openai
    why: "Compare local token counts against OpenAI billing usage"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI dashboard -> API keys"

must_haves:
  truths:
    - "Running the verification harness compares proxy /v1/messages/count_tokens to OpenAI usage.input_tokens and reports matches/mismatches."
    - "Verification steps with sample inputs/outputs are documented for Phase 6."
    - "Phase 2 verification report reflects that OpenAI billing alignment has been checked."
  artifacts:
    - path: "scripts/verify_count_tokens.py"
      provides: "Harness that calls proxy + OpenAI and compares input token counts"
    - path: "scripts/fixtures/token_count_cases.json"
      provides: "Sample anthropic payloads for verification"
    - path: ".planning/phases/06-token-count-billing-alignment-verification/06-token-count-billing-alignment-report.md"
      provides: "Recorded sample inputs/outputs and comparison results"
    - path: ".planning/phases/06-token-count-billing-alignment-verification/06-VERIFICATION.md"
      provides: "Runnable verification steps"
    - path: ".planning/phases/02-token-counting-alignment/02-token-counting-alignment-VERIFICATION.md"
      provides: "Updated TOK-01 evidence"
  key_links:
    - from: "scripts/verify_count_tokens.py"
      to: "/v1/messages/count_tokens"
      via: "HTTP POST to proxy"
      pattern: "/v1/messages/count_tokens"
    - from: "scripts/verify_count_tokens.py"
      to: "https://api.openai.com/v1/responses"
      via: "HTTP POST with OPENAI_API_KEY"
      pattern: "/responses"
    - from: "scripts/verify_count_tokens.py"
      to: "src/mapping/anthropic_to_openai.py"
      via: "map_anthropic_request_to_openai"
      pattern: "map_anthropic_request_to_openai"
---

<objective>
Create a repeatable verification harness and documentation proving /v1/messages/count_tokens matches OpenAI billing usage.

Purpose: Close the Phase 2 alignment verification gap with concrete evidence.
Output: A multi-case harness, a recorded report with sample inputs/outputs, and updated Phase 2 verification status.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/token_counting/openai_count.py
@src/handlers/count_tokens.py
@scripts/verify_count_tokens.py
@.planning/phases/02-token-counting-alignment/02-token-counting-alignment-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand verification harness + write comparison report</name>
  <files>
    scripts/verify_count_tokens.py
    scripts/fixtures/token_count_cases.json
    .planning/phases/06-token-count-billing-alignment-verification/06-token-count-billing-alignment-report.md
  </files>
  <action>
    - Extend scripts/verify_count_tokens.py to load multiple anthropic payload cases from scripts/fixtures/token_count_cases.json.
    - For each case: POST to {PROXY_BASE}/v1/messages/count_tokens, map via map_anthropic_request_to_openai, then POST to OpenAI /responses and read usage.input_tokens.
    - Capture per-case results (case name, proxy input_tokens, openai usage.input_tokens, match boolean) and write a markdown report at .planning/phases/06-token-count-billing-alignment-verification/06-token-count-billing-alignment-report.md.
    - Include at least two sample inputs and their output counts in the report (embed JSON payloads + observed token counts).
    - Exit non-zero if any case mismatches so failures are visible during verification.
    - Keep existing env vars (OPENAI_API_KEY, OPENAI_BASE_URL, PROXY_BASE) and add a friendly error message if OPENAI_API_KEY is missing.
  </action>
  <verify>python scripts/verify_count_tokens.py</verify>
  <done>Report file exists with a table of case results and sample inputs/outputs; script exits 0 when all cases match.</done>
</task>

<task type="auto">
  <name>Task 2: Document verification steps + update Phase 2 verification</name>
  <files>
    .planning/phases/06-token-count-billing-alignment-verification/06-VERIFICATION.md
    .planning/phases/02-token-counting-alignment/02-token-counting-alignment-VERIFICATION.md
  </files>
  <action>
    - Create .planning/phases/06-token-count-billing-alignment-verification/06-VERIFICATION.md documenting how to run the harness (env vars, expected output, and where the report is written).
    - Reference the generated report file and include a short sample output snippet in the doc.
    - Update the Phase 2 verification report to mark the TOK-01 requirement as verified based on the report (set status to verified and add evidence line referencing the report file and run date).
    - Remove or resolve the human_needed status in the Phase 2 verification frontmatter to reflect completion.
  </action>
  <verify>Confirm Phase 2 verification status shows TOK-01 as verified and references the Phase 6 report.</verify>
  <done>Phase 6 verification steps are documented and Phase 2 verification no longer requires human billing alignment checks.</done>
</task>

</tasks>

<verification>
- python scripts/verify_count_tokens.py (expects match=true for all cases)
- Review .planning/phases/06-token-count-billing-alignment-verification/06-VERIFICATION.md for steps and sample outputs
- Confirm .planning/phases/02-token-counting-alignment/02-token-counting-alignment-VERIFICATION.md marks TOK-01 as verified
</verification>

<success_criteria>
- A multi-case harness compares proxy input_tokens to OpenAI usage.input_tokens with a stored report.
- Verification steps and sample inputs/outputs are documented for Phase 6.
- Phase 2 verification report reflects completed billing alignment verification.
</success_criteria>

<output>
After completion, create `.planning/phases/06-token-count-billing-alignment-verification/06-01-SUMMARY.md`
</output>

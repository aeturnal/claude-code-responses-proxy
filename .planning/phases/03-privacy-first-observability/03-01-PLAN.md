---
phase: 03-privacy-first-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - src/config.py
  - src/observability/__init__.py
  - src/observability/logging.py
  - src/middleware/__init__.py
  - src/middleware/observability.py
  - src/app.py
autonomous: true

must_haves:
  truths:
    - "Structured JSON request logs are emitted with content redacted by default when logging is enabled"
    - "Structured JSON response logs are emitted with content redacted by default when logging is enabled"
    - "Each request/response log entry includes a correlation ID from x-correlation-id"
    - "Logging is opt-in and writes to stdout and a log file"
  artifacts:
    - path: "src/observability/logging.py"
      provides: "structlog configuration + logger factory gated by env flags"
      contains: "configure_logging"
    - path: "src/middleware/observability.py"
      provides: "request timing and correlation-id context binding"
      contains: "bind_contextvars"
    - path: "src/app.py"
      provides: "logging setup and correlation-id middleware wiring"
      contains: "CorrelationIdMiddleware"
    - path: "requirements.txt"
      provides: "observability dependencies"
      contains: "structlog"
  key_links:
    - from: "src/app.py"
      to: "src/observability/logging.py"
      via: "configure_logging call"
      pattern: "configure_logging"
    - from: "src/app.py"
      to: "CorrelationIdMiddleware"
      via: "app.add_middleware"
      pattern: "add_middleware\\(CorrelationIdMiddleware"
    - from: "src/middleware/observability.py"
      to: "structlog.contextvars"
      via: "clear/bind per request"
      pattern: "clear_contextvars|bind_contextvars"
---

<objective>
Establish observability foundations with logging configuration, environment flags, and correlation-id middleware.

Purpose: Enable opt-in structured logging and correlation IDs across the app without touching request bodies.
Output: Logging config module, middleware wiring, and updated dependencies/config.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-privacy-first-observability/03-CONTEXT.md
@.planning/phases/03-privacy-first-observability/03-RESEARCH.md

@requirements.txt
@src/app.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add observability dependencies + logging config helpers</name>
  <files>requirements.txt, src/config.py, src/observability/__init__.py, src/observability/logging.py</files>
  <action>
Update requirements with structlog, asgi-correlation-id, presidio-analyzer, and presidio-anonymizer.

Extend src/config.py with observability env flags:
- OBS_LOG_ENABLED (default false)
- OBS_LOG_FILE (path for file output, default "./logs/requests.log")
- OBS_REDACTION_MODE ("full" default, "partial" when enabled)
- OBS_LOG_PRETTY (default true)

Create src/observability/logging.py to:
- configure structlog with contextvars support, timestamp, level, and JSON renderer (pretty when enabled).
- configure stdlib logging handlers for stdout (INFO+), stderr (ERROR+), and file output.
- expose configure_logging() and logging_enabled() helpers.
- avoid attaching handlers when logging is disabled.

Do not log any payloads here; this module only configures logging.
  </action>
  <verify>python -m compileall src</verify>
  <done>Observability dependencies are listed and logging configuration can initialize without errors when enabled.</done>
</task>

<task type="auto">
  <name>Task 2: Wire correlation ID + timing middleware</name>
  <files>src/middleware/__init__.py, src/middleware/observability.py, src/app.py</files>
  <action>
Create src/middleware/observability.py with an HTTP middleware that:
- clears and binds structlog contextvars per request
- captures start time in request.state.start_time
- pulls the correlation ID from asgi-correlation-id and stores it in request.state.correlation_id
- does NOT read request.body() or response body

Update src/app.py to:
- call configure_logging() during app setup
- add CorrelationIdMiddleware with header_name="X-Correlation-ID"
- register the timing/context middleware

Keep behavior compatible with existing handlers (no new endpoints).
  </action>
  <verify>python -m compileall src</verify>
  <done>App initializes logging, sets correlation IDs, and captures per-request timing without consuming request bodies.</done>
</task>

</tasks>

<verification>
- python -m compileall src
</verification>

<success_criteria>
- Observability dependencies and config flags exist.
- Correlation IDs are generated/preserved and bound into request context.
- Logging setup can be enabled without runtime errors.
</success_criteria>

<output>
After completion, create `.planning/phases/03-privacy-first-observability/03-01-SUMMARY.md`
</output>

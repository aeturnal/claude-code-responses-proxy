---
phase: 03-privacy-first-observability
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/observability/__init__.py
  - src/observability/redaction.py
  - src/handlers/messages.py
  - src/handlers/count_tokens.py
  - src/transport/openai_client.py
autonomous: true

must_haves:
  truths:
    - "Structured JSON request logs are emitted with content redacted by default when logging is enabled"
    - "Structured JSON response logs are emitted with content redacted by default when logging is enabled"
    - "Each request/response log entry includes a correlation ID from x-correlation-id"
    - "Logging is opt-in and writes to stdout and a log file"
  artifacts:
    - path: "src/observability/redaction.py"
      provides: "PII redaction helpers for Anthropic request/response payloads"
      contains: "redact_"
    - path: "src/handlers/messages.py"
      provides: "request/response logging with redaction for /v1/messages"
      contains: "logger.info"
    - path: "src/handlers/count_tokens.py"
      provides: "request/response logging with redaction for /v1/messages/count_tokens"
      contains: "logger.info"
    - path: "src/transport/openai_client.py"
      provides: "optional X-Correlation-ID propagation upstream"
      contains: "X-Correlation-ID"
  key_links:
    - from: "src/handlers/messages.py"
      to: "src/observability/redaction.py"
      via: "redact_* helpers"
      pattern: "redact_.*request|redact_.*response"
    - from: "src/handlers/count_tokens.py"
      to: "src/observability/redaction.py"
      via: "redact_* helpers"
      pattern: "redact_.*request|redact_.*response"
    - from: "src/transport/openai_client.py"
      to: "asgi_correlation_id"
      via: "header propagation"
      pattern: "Correlation-ID"
---

<objective>
Add PII-redacted request/response logging and correlation propagation to cover OBS-01 and OBS-02.

Purpose: Provide operators with safe, traceable observability for requests and responses.
Output: Redaction utilities and handler-level structured logs.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-privacy-first-observability/03-CONTEXT.md
@.planning/phases/03-privacy-first-observability/03-RESEARCH.md

@src/schema/anthropic.py
@src/handlers/messages.py
@src/handlers/count_tokens.py
@src/transport/openai_client.py
@src/observability/logging.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PII redaction helpers</name>
  <files>src/observability/__init__.py, src/observability/redaction.py</files>
  <action>
Create src/observability/redaction.py with conservative redaction rules:
- redact_text(text, mode):
  - mode "full" -> return "[REDACTED]" for any string
  - mode "partial" -> use Presidio Analyzer/Anonymizer to replace detected spans with "[REDACTED]"; fallback to full redaction on errors

Provide helpers to redact Anthropic payloads while preserving structure:
- redact_messages_request(MessagesRequest | dict) -> dict
  - redact system, message content blocks, tool definitions, tool choice names/inputs
- redact_anthropic_response(dict) -> dict
  - redact text blocks and tool_use inputs
- redact_openai_error(dict) -> dict
  - redact error messages/params defensively

Keep non-sensitive fields (model name, max_tokens, counts) intact.
  </action>
  <verify>python -m compileall src</verify>
  <done>Redaction helpers can return fully redacted payloads and optionally partial redaction when enabled.</done>
</task>

<task type="auto">
  <name>Task 2: Emit structured logs in handlers and propagate correlation ID upstream</name>
  <files>src/handlers/messages.py, src/handlers/count_tokens.py, src/transport/openai_client.py</files>
  <action>
Update /v1/messages and /v1/messages/count_tokens handlers to accept Request and log structured events when logging is enabled:
- On request entry: log event "request" with endpoint, method, correlation_id, and redacted request payload.
- On response success: log event "response" with status_code, duration_ms, correlation_id, token usage (from OpenAI response or count_tokens), and redacted response payload.
- On upstream error: log event "error" with status_code and redacted error payload.

Use request.state.start_time to compute duration_ms, and redaction helpers for all payloads.

Update OpenAI transport to propagate the X-Correlation-ID header when a correlation ID exists (via asgi-correlation-id context) while preserving existing Authorization headers.

Ensure no raw request/response bodies are logged and logging is a no-op when OBS_LOG_ENABLED is false.
  </action>
  <verify>python -m compileall src</verify>
  <done>Handlers emit redacted structured logs with correlation IDs and upstream requests include X-Correlation-ID when available.</done>
</task>

</tasks>

<verification>
- python -m compileall src
</verification>

<success_criteria>
- Request and response logs are emitted with redacted content when logging is enabled.
- Correlation IDs appear in all structured logs and are optionally forwarded upstream.
- No log emission occurs when logging is disabled.
</success_criteria>

<output>
After completion, create `.planning/phases/03-privacy-first-observability/03-02-SUMMARY.md`
</output>

---
phase: 05-credential-error-envelope-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.py
  - src/handlers/messages.py
  - tests/test_missing_credentials.py
autonomous: true

must_haves:
  truths:
    - "/v1/messages without OPENAI_API_KEY returns HTTP 401 Anthropic error envelope"
    - "/v1/messages/stream without OPENAI_API_KEY emits SSE event:error with Anthropic envelope"
    - "Tests assert missing-credential error mapping for both HTTP and streaming paths"
  artifacts:
    - path: "src/config.py"
      provides: "MissingOpenAIAPIKeyError raised by require_openai_api_key"
      contains: "class MissingOpenAIAPIKeyError"
    - path: "src/handlers/messages.py"
      provides: "Missing credential handling for /v1/messages and /v1/messages/stream"
      contains: "except MissingOpenAIAPIKeyError"
    - path: "tests/test_missing_credentials.py"
      provides: "pytest coverage for missing OPENAI_API_KEY envelope parity"
      contains: "test_messages_missing_api_key"
  key_links:
    - from: "src/handlers/messages.py"
      to: "src.errors.anthropic_error.build_anthropic_error"
      via: "MissingOpenAIAPIKeyError handling"
      pattern: "build_anthropic_error\(401,\s*\"authentication_error\""
    - from: "src/handlers/messages.py"
      to: "_format_sse_error"
      via: "MissingOpenAIAPIKeyError in stream generator"
      pattern: "yield _format_sse_error\(error_payload\)"
    - from: "tests/test_missing_credentials.py"
      to: "src.app.app"
      via: "TestClient requests"
      pattern: "TestClient\(app\)"
---

<objective>
Add Anthropic error envelope handling for missing OpenAI credentials across /v1/messages and /v1/messages/stream, with pytest coverage.

Purpose: Ensure authentication failures match Anthropic error semantics instead of 500s.
Output: Updated credential error mapping plus tests for HTTP and SSE paths.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-credential-error-envelope-parity/05-RESEARCH.md

@src/config.py
@src/handlers/messages.py
@src/errors/anthropic_error.py
@src/transport/openai_client.py
@src/transport/openai_stream.py
@src/app.py
@src/schema/anthropic.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Map missing API key to Anthropic auth error (HTTP + SSE)</name>
  <files>src/config.py, src/handlers/messages.py</files>
  <action>
    - In src/config.py, add a MissingOpenAIAPIKeyError exception class and update require_openai_api_key() to raise it when OPENAI_API_KEY is unset (keep message "OPENAI_API_KEY is required").
    - In src/handlers/messages.py, import MissingOpenAIAPIKeyError and handle it in create_message(): build an Anthropic error envelope with status_code=401, error_type="authentication_error", message="OPENAI_API_KEY is required", and a synthetic openai_error payload like {"error": {"message": "OPENAI_API_KEY is required"}}; return JSONResponse(401, envelope).
    - In stream_messages() -> event_stream(), catch MissingOpenAIAPIKeyError separately from OpenAIUpstreamError, set stream_failed=True, log the error via redact_openai_error (using the synthetic openai_error payload), and yield _format_sse_error() with the Anthropic envelope (error_type="authentication_error").
    - Do NOT route MissingOpenAIAPIKeyError through map_openai_error_type; it must always be authentication_error.
  </action>
  <verify>pytest -q</verify>
  <done>/v1/messages returns 401 with authentication_error when no key; /v1/messages/stream emits event:error with the same envelope.</done>
</task>

<task type="auto">
  <name>Task 2: Add pytest coverage for missing credential envelopes</name>
  <files>tests/test_missing_credentials.py</files>
  <action>
    - Create tests/test_missing_credentials.py using fastapi.testclient.TestClient with src.app.app.
    - Use monkeypatch to set src.config.OPENAI_API_KEY = None for each test (avoid relying on env var reads at import time).
    - Test /v1/messages: POST a minimal valid request (model + user message). Assert status_code==401 and response JSON has type=="error", error.type=="authentication_error", and error.openai.error.message=="OPENAI_API_KEY is required".
    - Test /v1/messages/stream: POST the same request using client.stream("POST", ...). Assert response.status_code==200, content-type includes text/event-stream, and the streamed body contains "event: error" with data JSON whose error.type=="authentication_error".
  </action>
  <verify>pytest -q</verify>
  <done>Tests fail before the handler changes and pass after, covering both HTTP and streaming missing-key flows.</done>
</task>

</tasks>

<verification>
- pytest -q
</verification>

<success_criteria>
- /v1/messages without OPENAI_API_KEY returns 401 Anthropic error envelope (authentication_error).
- /v1/messages/stream without OPENAI_API_KEY emits SSE event:error with Anthropic envelope.
- pytest covers missing-credential mapping for both endpoints.
</success_criteria>

<output>
After completion, create `.planning/phases/05-credential-error-envelope-parity/05-01-SUMMARY.md`
</output>

---
phase: 01-core-messages-parity
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/schema/anthropic.py
  - src/schema/openai.py
  - src/mapping/anthropic_to_openai.py
autonomous: true
must_haves:
  truths:
    - "Anthropic /v1/messages payloads can be normalized into OpenAI Responses requests"
    - "System instructions are mapped to OpenAI instructions (not injected as system-role messages)"
  artifacts:
    - path: "src/schema/anthropic.py"
      provides: "Anthropic Messages request models"
      contains: "class MessagesRequest"
    - path: "src/schema/openai.py"
      provides: "OpenAI Responses request models"
      contains: "class OpenAIResponsesRequest"
    - path: "src/mapping/anthropic_to_openai.py"
      provides: "Request mapping function"
      exports: ["map_anthropic_request_to_openai"]
  key_links:
    - from: "src/mapping/anthropic_to_openai.py"
      to: "src/schema/anthropic.py"
      via: "typed request parsing"
      pattern: "from src\.schema\.anthropic import MessagesRequest"
    - from: "src/mapping/anthropic_to_openai.py"
      to: "src/schema/openai.py"
      via: "OpenAI request assembly"
      pattern: "OpenAIResponsesRequest"
---

<objective>
Define Anthropic/OpenAI request schemas and implement deterministic request mapping for /v1/messages.

Purpose: Ensure Anthropic inputs map correctly into OpenAI Responses requests with tool and system handling.
Output: Typed request models and mapping logic.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-messages-parity/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Anthropic Messages request models</name>
  <files>src/schema/anthropic.py</files>
  <action>
    - Create Pydantic models for MessagesRequest, Message, and ContentBlock.
    - Support message roles user/assistant, with content as string or list of content blocks.
    - Implement content block types: text ({type: "text", text: string}) and tool_result ({type: "tool_result", tool_use_id: string, content: string|list}).
    - Include optional system (string or list of text blocks), tools list (name/description/parameters), tool_choice (auto/none/specific tool), and max_tokens.
  </action>
  <verify>python -c "from src.schema.anthropic import MessagesRequest; print(MessagesRequest.model_fields.keys())"</verify>
  <done>Anthropic request payloads validate with explicit roles, content blocks, and tool definitions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement OpenAI request schema + request mapping</name>
  <files>src/schema/openai.py, src/mapping/anthropic_to_openai.py</files>
  <action>
    - Define OpenAI Responses request models for input message items (type=message, role=user/system/developer) with content items (input_text).
    - Implement map_anthropic_request_to_openai(request: MessagesRequest) that:
      - Resolves model via resolve_openai_model.
      - Maps system to instructions string (join text blocks with \n if list).
      - Maps each message to input items with content as input_text blocks; raise ValueError on unsupported block types (non-text/tool_result) to keep deterministic behavior.
      - Maps tools to OpenAI FunctionTool schema (type=function, function.name/description/parameters, strict=false).
      - Maps tool_choice: auto/none passthrough, specific tool -> {"type":"function","function":{"name":...}}.
  </action>
  <verify>python -c "from src.mapping.anthropic_to_openai import map_anthropic_request_to_openai; print('ok')"</verify>
  <done>Anthropic request objects deterministically produce OpenAI Responses request payloads.</done>
</task>

</tasks>

<verification>
- Request schema models import and instantiate without validation errors.
- Mapping function produces OpenAI-compatible payloads with instructions + input items.
</verification>

<success_criteria>
- Anthropic /v1/messages requests map to OpenAI Responses input with correct system/tool handling.
- Mapping raises explicit errors for unsupported block types to keep behavior deterministic.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-messages-parity/01-02-SUMMARY.md`
</output>

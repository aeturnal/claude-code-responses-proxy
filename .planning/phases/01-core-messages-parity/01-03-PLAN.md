---
phase: 01-core-messages-parity
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/mapping/openai_to_anthropic.py
  - tests/test_openai_to_anthropic.py
autonomous: true
must_haves:
  truths:
    - "OpenAI Responses outputs are normalized into Anthropic message content blocks"
    - "stop_reason is derived deterministically from OpenAI response status/details"
  artifacts:
    - path: "src/mapping/openai_to_anthropic.py"
      provides: "Response mapping + stop_reason logic"
      exports: ["map_openai_response_to_anthropic", "derive_stop_reason"]
    - path: "tests/test_openai_to_anthropic.py"
      provides: "Stop-reason and tool_use mapping tests"
      contains: "derive_stop_reason"
  key_links:
    - from: "src/mapping/openai_to_anthropic.py"
      to: "tests/test_openai_to_anthropic.py"
      via: "pytest verification"
      pattern: "derive_stop_reason"
---

<objective>
Implement deterministic OpenAI-to-Anthropic response normalization, including stop_reason mapping.

Purpose: Guarantee Anthropic-compatible response shapes and stop_reason semantics.
Output: Response mapping utilities with tests validating stop_reason behavior.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-messages-parity/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement OpenAI response → Anthropic mapping</name>
  <files>src/mapping/openai_to_anthropic.py</files>
  <action>
    - Implement derive_stop_reason(response: dict) using response.status and incomplete_details.reason:
      - If any output item type == "function_call" → stop_reason = "tool_use".
      - Else if incomplete_details.reason == "max_output_tokens" → "max_tokens".
      - Else if incomplete_details.reason == "content_filter" → "refusal".
      - Else default to "end_turn".
    - Implement map_openai_response_to_anthropic(response: dict) to build Anthropic message object:
      - Map output items of type "message" with content items type "output_text" to Anthropic text blocks.
      - Map output items of type "function_call" to Anthropic tool_use blocks (id=call_id, name, input parsed from arguments JSON; fallback to raw string on JSON error).
      - Set stop_reason via derive_stop_reason.
  </action>
  <verify>python -c "from src.mapping.openai_to_anthropic import derive_stop_reason, map_openai_response_to_anthropic; print('ok')"</verify>
  <done>OpenAI responses normalize into Anthropic message shape with deterministic stop_reason.</done>
</task>

<task type="auto">
  <name>Task 2: Add pytest coverage for stop_reason and tool_use mapping</name>
  <files>tests/test_openai_to_anthropic.py</files>
  <action>
    - Add tests covering:
      - Completed message output → stop_reason "end_turn" + text block.
      - Function call output → stop_reason "tool_use" + tool_use block with parsed input.
      - incomplete_details.reason max_output_tokens → stop_reason "max_tokens".
      - incomplete_details.reason content_filter → stop_reason "refusal".
  </action>
  <verify>pytest tests/test_openai_to_anthropic.py</verify>
  <done>Tests validate stop_reason derivation and tool_use block normalization.</done>
</task>

</tasks>

<verification>
- pytest passes for response mapping tests.
</verification>

<success_criteria>
- stop_reason values align with Anthropic semantics for typical completion, max_tokens, and refusal cases.
- tool_use blocks appear when OpenAI returns function_call output items.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-messages-parity/01-03-SUMMARY.md`
</output>

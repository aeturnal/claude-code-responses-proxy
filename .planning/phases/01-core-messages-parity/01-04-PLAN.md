---
phase: 01-core-messages-parity
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - src/app.py
  - src/handlers/messages.py
  - src/errors/anthropic_error.py
autonomous: true
must_haves:
  truths:
    - "User can POST /v1/messages and receive Anthropic-compatible response shape"
    - "Upstream OpenAI errors return deterministic Anthropic error envelopes"
  artifacts:
    - path: "src/handlers/messages.py"
      provides: "/v1/messages FastAPI route"
      exports: ["router"]
    - path: "src/errors/anthropic_error.py"
      provides: "Anthropic error envelope builder"
      exports: ["build_anthropic_error"]
    - path: "src/app.py"
      provides: "FastAPI app wiring"
      contains: "FastAPI()"
  key_links:
    - from: "src/handlers/messages.py"
      to: "src/mapping/anthropic_to_openai.py"
      via: "request mapping"
      pattern: "map_anthropic_request_to_openai"
    - from: "src/handlers/messages.py"
      to: "src/mapping/openai_to_anthropic.py"
      via: "response mapping"
      pattern: "map_openai_response_to_anthropic"
    - from: "src/handlers/messages.py"
      to: "src/transport/openai_client.py"
      via: "OpenAI Responses call"
      pattern: "create_openai_response"
---

<objective>
Expose /v1/messages with deterministic Anthropic-compatible responses and error envelopes.

Purpose: Deliver the Phase 1 user-facing endpoint with correct success and error shapes.
Output: FastAPI app + handler + error mapping for /v1/messages.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-messages-parity/01-RESEARCH.md
@.planning/phases/01-core-messages-parity/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Anthropic error envelope helper</name>
  <files>src/errors/anthropic_error.py</files>
  <action>
    - Implement build_anthropic_error(status_code, error_type, message, param=None, code=None, openai_error=None).
    - Return dict: {"type":"error","error":{"type":error_type,"message":message,"param":param,"code":code,"openai":openai_error}}.
    - Provide helper for mapping OpenAI error payloads into error_type (default "api_error" when unknown).
  </action>
  <verify>python -c "from src.errors.anthropic_error import build_anthropic_error; print(build_anthropic_error(400,'invalid_request_error','bad').keys())"</verify>
  <done>Deterministic Anthropic error envelope includes OpenAI details when present.</done>
</task>

<task type="auto">
  <name>Task 2: Implement /v1/messages handler and app wiring</name>
  <files>src/handlers/messages.py, src/app.py</files>
  <action>
    - Create FastAPI router with POST /v1/messages accepting MessagesRequest.
    - Map request via map_anthropic_request_to_openai, call create_openai_response, then normalize via map_openai_response_to_anthropic.
    - Catch OpenAIUpstreamError and return build_anthropic_error with upstream error payload and HTTP status code.
    - Add FastAPI exception handler for RequestValidationError to return 400 with build_anthropic_error("invalid_request_error", ...).
    - Wire router into FastAPI app in src/app.py.
  </action>
  <verify>python -m uvicorn src.app:app --port 8000</verify>
  <done>/v1/messages returns Anthropic-compatible success and error envelopes when exercised locally.</done>
</task>

</tasks>

<verification>
- Start server and POST a minimal Anthropic request; response includes type=message, role=assistant, content list, stop_reason.
- Trigger upstream error (invalid API key) and verify Anthropic error envelope with OpenAI details.
</verification>

<success_criteria>
- /v1/messages accepts Anthropic request shape and returns Anthropic-compatible response shape.
- Upstream OpenAI errors map to deterministic Anthropic error envelopes with OpenAI details included.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-messages-parity/01-04-SUMMARY.md`
</output>

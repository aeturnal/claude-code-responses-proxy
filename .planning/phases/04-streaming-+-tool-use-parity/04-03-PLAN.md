---
phase: 04-streaming-+-tool-use-parity
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - src/handlers/messages.py
autonomous: true
must_haves:
  truths:
    - "User can open /v1/messages/stream and receive Anthropic SSE lifecycle events"
    - "Tool use blocks stream with input_json_delta and finalize at content_block_stop"
    - "Streaming errors surface as Anthropic error events"
  artifacts:
    - path: "src/handlers/messages.py"
      provides: "/v1/messages/stream SSE endpoint"
  key_links:
    - from: "src/handlers/messages.py"
      to: "src/transport/openai_stream.py"
      via: "stream_openai_events"
      pattern: "stream_openai_events"
    - from: "src/handlers/messages.py"
      to: "src/mapping/openai_stream_to_anthropic.py"
      via: "translate_openai_events"
      pattern: "translate_openai_events"
    - from: "src/handlers/messages.py"
      to: "src/mapping/anthropic_to_openai.py"
      via: "map_anthropic_request_to_openai"
      pattern: "map_anthropic_request_to_openai"
---

<objective>
Expose `/v1/messages/stream` and wire it to the streaming transport + translator to deliver Anthropic-compatible SSE.

Purpose: Provide end-to-end streaming parity for Claude Code clients.
Output: Working streaming endpoint with correct event ordering and tool_use deltas.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-streaming-+-tool-use-parity/04-RESEARCH.md
@src/handlers/messages.py
@src/observability/redaction.py
@src/mapping/anthropic_to_openai.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /v1/messages/stream SSE endpoint</name>
  <files>src/handlers/messages.py</files>
  <action>
Add a new FastAPI route `@router.post("/v1/messages/stream")` that returns a `StreamingResponse` with `text/event-stream`.

Implementation details:
- Accept `MessagesRequest` like the non-streaming endpoint.
- Map request with `map_anthropic_request_to_openai`, then convert to dict and set `payload["stream"] = True`.
- Create an async generator that:
  - Iterates `stream_openai_events(payload)` from `src.transport`.
  - Passes the event iterator to `translate_openai_events` from `src.mapping`.
  - Yields each SSE string from the translator directly to the response.
- Set response headers appropriate for SSE (`Cache-Control: no-cache`, `Connection: keep-alive`).
  </action>
  <verify>python -m compileall src</verify>
  <done>/v1/messages/stream returns a StreamingResponse that yields Anthropic-formatted SSE events.</done>
</task>

<task type="auto">
  <name>Task 2: Handle streaming errors + observability logging</name>
  <files>src/handlers/messages.py</files>
  <action>
Wrap the stream generator to ensure streaming errors are surfaced and requests are logged:

- At request start, emit a `request` log mirroring `/v1/messages` (use `redact_messages_request`).
- In the generator, catch `OpenAIUpstreamError` and emit an SSE `event: error` with `build_anthropic_error(...)` payload before stopping.
- Track the latest `message_delta` usage payload (inspect emitted SSE events for `event: message_delta`) and log a `response` entry on completion with duration + usage if available.
- Do not log per-delta content to avoid PII leakage; keep logs summary-level.
  </action>
  <verify>
1) Start the server: `python -m uvicorn src.app:app --reload`.
2) Stream a request:
   `curl -N http://localhost:8000/v1/messages/stream -H "Content-Type: application/json" -d '{"model":"claude-3-5-sonnet","messages":[{"role":"user","content":"Hello"}],"max_tokens":32}'`
3) Confirm SSE events arrive in order: message_start → content_block_* → message_delta → message_stop.
  </verify>
  <done>Streaming requests log request/response summaries and surface errors as Anthropic SSE error events.</done>
</task>

</tasks>

<verification>
- `python -m compileall src` succeeds.
- `curl -N` receives ordered Anthropic SSE events from `/v1/messages/stream`.
</verification>

<success_criteria>
- Clients can stream SSE events with correct message/content block lifecycle ordering, including tool_use input_json_delta handling.</success_criteria>

<output>
After completion, create `.planning/phases/04-streaming-+-tool-use-parity/04-03-SUMMARY.md`
</output>
